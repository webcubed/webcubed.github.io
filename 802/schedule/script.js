const schedule = {
	monday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "PE",
			room: "GYM",
			teacher: "Belmonte",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
	],
	tuesday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Non-Core Math",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Talent",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "PE",
			room: "GYM",
			teacher: "Belmonte",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
	],
	wednesday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Non-Core ELA",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
	],
	thursday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Talent",
			room: "N/A",
			teacher: "N/A",
		},
	],
	friday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Non-Core Math",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "Talent",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
	],
};
const PENote =
	"On our PE days, Mondays and Tuesdays, we always have Biology right after lunch, Algebra last, and History NEXT TO PE (either before or after). ";
const TalentNote =
	"We have Talent on Tuesdays, Thursdays, and Fridays. Tuesdays 5th period right before PE, Thursdays last period, and Fridays second to last period, preceded by History and followed by Spanish. (Band students can easily memorize this because they stay in one side of the building for the last three periods.)";
const days = {
	monday: {
		doubles: [
			{
				subject: "History",
				periods: [2, 6],
			},
		],
		tags: ["PE", "Double"],
		specialNotes: [PENote],
		note: "On Mondays, we have PE 7th, followed by Algebra and preceded by History. We have one double period, History on periods 2 and 6.",
	},
	tuesday: {
		doubles: [
			{
				subject: "Math", // NOT ALGEBRA or NONCORE, MATH MEANS BOTH
				periods: [1, 8],
			},
		],
		tags: ["PE", "Talent", "No Spanish", "Non-Core", "Non-Core Math", "Double"],
		specialNotes: [PENote, TalentNote],
		note: "On Tuesdays, we have PE 6th, followed by History and preceded by Talent. We have a technical double for Math, with Non-Core Math being first and Algebra being last. This is the only day in the school week without Spanish",
	},
	wednesday: {
		doubles: [
			{
				subject: "Algebra",
				periods: [1, 5],
			},
			{
				subject: "English", // Not ELA, both ELA & Noncore Ela
				periods: [2, 4],
			},
		],
		tags: ["Non-Core", "Non-Core ELA", "Double"],
		specialNotes: [],
		note: "This is our only day with Non-Core ELA, situated right after lunch. Our first five periods are as follows: Algebra -> ELA -> Lunch -> Non-Core ELA -> Algebra. This makes it easy to remember, as the two periods after lunch are just the first two periods inversed. We have a genuine Algebra double on this day as well.",
	},
	thursday: {
		doubles: [{ subject: "Biology", periods: [1, 6] }],
		tags: ["Talent", "Double"],
		specialNotes: [TalentNote],
		note: "This our day with a biology double period, on period 1 and 6. This was our first day of school, so the first two periods are Bio -> History. After lunch you can abbreviate it to ESPLEAT (Ela -> SPanish -> Living Enviornment -> Algebra -> Talent)",
	},
	friday: {
		doubles: [{ subject: "Math", periods: [4, 5] }],
		tags: ["Talent", "Double"],
		specialNotes: [TalentNote],
		note: "We have a consecutive double Math period today after lunch. Those with Fong in MTSS stay in the same room for the two periods. Talent is 7th period, preceded by History and followed by Spanish.",
	},
};
const _options = {
	left: [
		{
			colored: false,
		},
	],
	middle: [{}],
	right: [
		{
			colors: {
				border: "#cad3f5",
				text: "#cad3f5",
				background: "#181926",
			},
		},
	],
};
const _additionalTeachers = {
	// Talent teachers to be done
};
const _defaultColors = {
	Algebra: "#8aadf4",
	Biology: "#a6da95",
	ELA: "#ed8796",
	History: "#eed49f",
	"Non-Core ELA": "",
	"Non-Core Math": "",
	Spanish: "#c6a0f6",
	Talent: "",
	PE: "#f5a97f",
	Lunch: "#ee99a0",
};

/*
// Testing purposes
const _oldDate = Date;
const fakeDate = new Date("March 26, 2025 11:13:00");

// Overriding date function
Date = function () {
	return fakeDate;
};
*/

/**
 * Returns an object with functions to get the current day, hours, and minutes in New York time.
 * @returns {{getDay: function, getHours: function, getMinutes: function}}
 */
function getNYTime() {
	const dateString = new Date().toLocaleString("en-US", {
		timeZone: "America/New_York",
	});
	return {
		getDay: () => new Date(dateString).getDay(),
		getHours: () => new Date(dateString).getHours(),
		getMinutes: () => new Date(dateString).getMinutes(),
	};
}

/**
 * Gets the current period given the current time and day.
 * @returns The object for the current period if it is a valid period, otherwise null.
 */
function getPeriod() {
	// Get current day, ensure that it is monday through friday
	// const now = new Date(2024, 12, 20, 9, 30); // Testing purposes
	const now = getNYTime();
	const day = now.getDay();
	if (day === 0 || day === 6) {
		return null;
	}

	// Get current time, ensure that it is between 8:10 am and 2:30 pm
	const hour = now.getHours();
	const minute = now.getMinutes();
	const currentTimeInMinutes = hour * 60 + minute;

	if (!(currentTimeInMinutes >= 490 && currentTimeInMinutes <= 870)) {
		return null;
	}

	// Get current day in text
	const daysOfWeek = [
		"sunday",
		"monday",
		"tuesday",
		"wednesday",
		"thursday",
		"friday",
		"saturday",
	];
	const todaySchedule = schedule[daysOfWeek[day]];

	// Check which period it currently is
	for (const period of todaySchedule) {
		const [start, end] = period.timeRange.split("-");
		const [startHour, startMinute] = start.split(":").map(Number);
		const [endHour, endMinute] = end.split(":").map(Number);

		const startTimeInMinutes = startHour * 60 + startMinute;
		const endTimeInMinutes = endHour * 60 + endMinute;

		if (
			currentTimeInMinutes >= startTimeInMinutes &&
			currentTimeInMinutes <= endTimeInMinutes
		) {
			return period;
		}
	}

	return null;
}

const daysOfSchoolWeek = [
	"monday",
	"tuesday",
	"wednesday",
	"thursday",
	"friday",
];

/**
 * Updates the gradient for each day of the school week in the default schedule based on the current time
 */
function updateDayGradients() {
	// Get the index of the current day in the school week
	const schoolToday = (getNYTime().getDay() + 6) % 7;

	// Loop through each day of the school week
	for (const day of daysOfSchoolWeek) {
		// Get the table header element for the current day being looped through
		const th = document.querySelector(`#defaultschedule th[data-day="${day}"]`);

		// Get the index of the current day in the array of strings containing school day names.
		const dayIndex = daysOfSchoolWeek.indexOf(day);

		// If the current day is in the past, set the background to blue
		if (dayIndex < schoolToday) {
			th.style.background = "var(--blue)";
		}
		// If the current day is today, calculate the gradient percentage
		else if (dayIndex === schoolToday) {
			// Get the current time
			const now = getNYTime();
			const hour = now.getHours();
			const minute = now.getMinutes();

			// Calculate the current time in minutes
			const currentTimeInMinutes = hour * 60 + minute;

			// Define the start and end times for the gradient
			const startTimeInMinutes = 8 * 60 + 10; // 8:10
			const endTimeInMinutes = 14 * 60 + 30; // 14:30

			// If the current time is after the end time, set the background to blue
			// This is being done because it will attempt to run the gradient AFTER SCHOOL
			// ^ which means not redundant
			if (currentTimeInMinutes > endTimeInMinutes) {
				th.style.background = "var(--blue)";
			} else if (currentTimeInMinutes < startTimeInMinutes) {
				// Don't bother if school hasn't started yet
				th.style.background = "";
			}
			// Otherwise, calculate the gradient percentage
			else {
				// Calculate the percentage of the day that has passed
				const percentage =
					((currentTimeInMinutes - startTimeInMinutes) /
						(endTimeInMinutes - startTimeInMinutes)) *
					100;

				// Set the background to a linear gradient with the percentage
				th.style.background = `linear-gradient(to right, var(--blue), transparent ${percentage}%)`;
			}
		}
	}
}

/**
 * Updates the gradient for each period in the default schedule based on the current time
 */
// Current problem: Gradients aren't accurate, percentage may be accurate but not represented as so.
function updatePeriodGradients() {
	// Get the day of the week
	const schoolToday = (getNYTime().getDay() + 6) % 7;

	// Loop through each day of the school week
	for (const day of daysOfSchoolWeek) {
		// The variable day returns a string of a day in the school week
		// Loop through each period for the current day
		for (const period of schedule[day]) {
			// The variable period returns an object with details about the period.
			// Continue only of today is the current day
			if (day !== daysOfSchoolWeek[schoolToday]) {
				continue;
			}

			// Getting the element corresponding to the current period being looped through.
			const td = document.querySelector(
				`#defaultschedule td[data-period="${day}-${schedule[day].indexOf(period) + 1}"]`
			);

			// Get the time in minutes for the current time
			const now = getNYTime();
			const hour = now.getHours();
			const minute = now.getMinutes();
			const currentTimeInMinutes = hour * 60 + minute;

			// Get the start and end time in minutes for the current period
			const [start, end] = period.timeRange.split("-");
			const [startHour, startMinute] = start.split(":").map(Number);
			const [endHour, endMinute] = end.split(":").map(Number);
			const startTimeInMinutes = startHour * 60 + startMinute;
			const endTimeInMinutes = endHour * 60 + endMinute;

			// If the current time is after the end of the period, show solid color and stop updating its gradient
			if (currentTimeInMinutes > endTimeInMinutes) {
				// If period has already ended, show solid color and stop updating its gradient
				td.style.background = "var(--blue)";
				td.dataset.periodOver = true;
				continue;
			} else if (
				currentTimeInMinutes >= startTimeInMinutes &&
				currentTimeInMinutes <= endTimeInMinutes
			) {
				// If the current time is between the start and end time of the period, show gradient
				const percentage =
					((currentTimeInMinutes - startTimeInMinutes) /
						(endTimeInMinutes - startTimeInMinutes)) *
					100;
				td.style.background = `linear-gradient(to right, var(--blue), transparent ${percentage}%)`;
			}
		}
	}
}

document.addEventListener("DOMContentLoaded", function () {
	// Get current period
	/* ----------------------------- table creation ----------------------------- */
	function createDefaultTable() {
		const table = document.querySelector("#defaultschedule");
		const thead = document.createElement("thead");
		const tbody = document.createElement("tbody");

		// Create table header
		const headerRow = document.createElement("tr");
		for (const day of daysOfSchoolWeek) {
			const th = document.createElement("th");
			th.textContent = day.charAt(0).toUpperCase() + day.slice(1);
			th.dataset.day = day;
			headerRow.append(th);
		}

		thead.append(headerRow);
		table.append(thead);

		// Find the maximum number of periods in any day
		const maxPeriods = Math.max(
			...daysOfSchoolWeek.map((day) => schedule[day]?.length || 0)
		);

		// Create table body
		for (let periodIndex = 0; periodIndex < maxPeriods; periodIndex++) {
			const row = document.createElement("tr");
			for (const day of daysOfSchoolWeek) {
				const td = document.createElement("td");
				const period = schedule[day]?.[periodIndex];
				td.textContent = period ? period.subject : "";
				td.dataset.period = `${day}-${periodIndex + 1}`;
				td.dataset.subject = period ? period.subject : "";
				row.append(td);
			}

			tbody.append(row);
		}

		table.append(tbody);
		return table;
	}

	/* ------------------------------ append tables ----------------------------- */
	// Append default table
	document.querySelector("#plain").append(createDefaultTable());
	setInterval(updateDayGradients, 1000);
	setInterval(updatePeriodGradients, 1000);

	// Register click listeners for updating info element
	const defaultTable = document.querySelector("#defaultschedule");
	const infoContainer = document.querySelector("#infocontainer");

	/**
	 * Creates a DOM element that displays the day name, double periods, special notes (if any), and regular notes for a given day of school.
	 * @param {Object} dayInfo - The day of school information containing the day's name, double periods, special notes (if any), and regular notes.
	 * @returns {Element} The DOM element that displays the information.
	 */
	function createDayInfo(dayInfo) {
		const parentDiv = document.createElement("div");
		parentDiv.id = "dayInfo";
		const dayName = Object.keys(days)[Object.values(days).indexOf(dayInfo)];
		parentDiv.innerHTML = `
		<div style="flex-grow: 1; display: flex; align-items: center;">
			<h1>${dayName.charAt(0).toUpperCase() + dayName.slice(1)}</h1>
		</div>`;
		const doublesDiv = document.createElement("div");
		doublesDiv.id = "doublesContainer";
		doublesDiv.style.display = "grid";
		doublesDiv.style.gridTemplateColumns = "1fr 1fr";
		doublesDiv.style.gridTemplateRows = "1fr 1fr";
		doublesDiv.innerHTML = `<h1 style="grid-column: 1/3;">Double Periods</h1>`;
		for (const item of dayInfo.doubles) {
			const itemDiv = document.createElement("div");
			itemDiv.innerHTML = `
			<h2>${item.subject}</h2>
			<h3>Periods: ${item.periods.join(", ")}</h3>
			`;
			if (dayInfo.doubles.length === 1) itemDiv.style.gridColumn = "1/3";
			doublesDiv.append(itemDiv);
		}

		parentDiv.append(doublesDiv);

		const noteContainer = document.createElement("div");
		noteContainer.innerHTML = `<h1>Notes</h1>`;
		const noteElement = document.createElement("p");
		noteElement.textContent = dayInfo.note;
		noteContainer.append(noteElement);
		if (dayInfo.specialNotes.length > 0) {
			const specialNotesContainer = document.createElement("div");

			specialNotesContainer.innerHTML = `<h1>Special Notes</h1>`;

			for (const note of dayInfo.specialNotes) {
				const specialNoteElement = document.createElement("p");
				specialNoteElement.id = "specialNote";
				specialNoteElement.textContent = note;
				specialNotesContainer.append(specialNoteElement);
			}

			parentDiv.append(specialNotesContainer);
		}

		parentDiv.append(noteContainer);
		return parentDiv;
	}

	// Register day listeners first (draw from thead > tr)
	for (const th of defaultTable.querySelector("thead > tr").childNodes) {
		const dayInfo = days[th.dataset.day];
		const schoolToday = (getNYTime().getDay() + 6) % 7;

		const interval = setInterval(() => {
			document.querySelector("#dayInfoContainer").innerHTML = "";
			document
				.querySelector("#dayInfoContainer")
				.append(createDayInfo(days[daysOfSchoolWeek[schoolToday]]));
		});

		th.addEventListener("click", () => {
			clearInterval(interval);
			document.querySelector("#dayInfoContainer").innerHTML = "";
			document
				.querySelector("#dayInfoContainer")
				.append(createDayInfo(dayInfo));
		});

		// Map the period object to the event target based on its data period attribute
		// get current day and get the respective object from days variable
		if (th.dataset.day !== daysOfSchoolWeek[schoolToday]) {
			continue;
		}
	}

	/**
	 * Creates a DOM element that displays information about a given period of school.
	 * @param {Object} periodInfo - The period of school information containing the period number, subject, teacher, room, and time range.
	 * @returns {Element} The DOM element that displays the information.
	 */
	function createPeriodInfo(periodInfo) {
		const parentDiv = document.createElement("div");
		parentDiv.id = "periodInfo";
		parentDiv.style.display = "flex";
		const periodName = periodInfo.period;
		parentDiv.innerHTML = `
		<div style="display: flex; align-items: center;">
			<h1>Period ${periodName} of ${
				Object.keys(schedule)[
					(() => {
						for (const [index, item] of Object.values(schedule).entries()) {
							if (item.includes(periodInfo) === true) {
								return index;
							}
						}

						return null;
					})()
				]
			}</h1>
		</div>`;
		const noteContainer = document.createElement("div");
		noteContainer.innerHTML = `<h1>Notes</h1>`;
		const noteElement = document.createElement("p");
		noteElement.innerHTML = `
		<h2>${periodInfo.subject}</h2>
		<h3>Teacher: ${periodInfo.teacher}</h3>
		<h3>Room: ${periodInfo.room}</h3>
		<h3>Time range (24 hr): ${periodInfo.timeRange}</h3>
		`;
		noteContainer.append(noteElement);
		parentDiv.append(noteContainer);
		return parentDiv;
	}

	for (const tr of defaultTable.querySelectorAll("tbody > tr")) {
		for (const td of tr.childNodes) {
			const periodInfo =
				schedule[td.dataset.period.split("-")[0]][
					td.dataset.period.split("-")[1] - 1
				];
			// If possible, open the period info for the current period
			const interval = setInterval(() => {
				if (getPeriod()) {
					infoContainer.querySelector("#periodInfoContainer").innerHTML = "";
					infoContainer
						.querySelector("#periodInfoContainer")
						.append(createPeriodInfo(getPeriod()));
				}
			}, 1000);

			td.addEventListener("click", () => {
				clearInterval(interval);
				document.querySelector("#periodInfoContainer").innerHTML = "";
				document
					.querySelector("#periodInfoContainer")
					.append(createPeriodInfo(periodInfo));
			});
		}
	}

	function _createOptions() {
		const table = document.querySelector("#options");
		const tbody = document.createElement("tbody");

		table.append(tbody);
	}

	// Document.body.append(createOptions());
});
