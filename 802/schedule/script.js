const schedule = {
	monday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "PE",
			room: "GYM",
			teacher: "Belmonte",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
	],
	tuesday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Non-Core Math",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Talent",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "PE",
			room: "GYM",
			teacher: "Belmonte",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
	],
	wednesday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Non-Core ELA",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
	],
	thursday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Talent",
			room: "N/A",
			teacher: "N/A",
		},
	],
	friday: [
		{
			period: 1,
			timeRange: "8:10-8:56",
			subject: "ELA",
			room: "159",
			teacher: "Kolansky",
		},
		{
			period: 2,
			timeRange: "8:58-9:43",
			subject: "Biology",
			room: "156",
			teacher: "Delaney",
		},
		{
			period: 3,
			timeRange: "9:45-10:30",
			subject: "Lunch",
			room: "CAFE",
			teacher: "Cuchapin",
		},
		{
			period: 4,
			timeRange: "10:32-11:18",
			subject: "Algebra",
			room: "204",
			teacher: "Fong",
		},
		{
			period: 5,
			timeRange: "11:20-12:05",
			subject: "Non-Core Math",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 6,
			timeRange: "12:07-12:53",
			subject: "History",
			room: "125",
			teacher: "Caviris",
		},
		{
			period: 7,
			timeRange: "12:55-13:41",
			subject: "Talent",
			room: "N/A",
			teacher: "N/A",
		},
		{
			period: 8,
			timeRange: "13:43-14:30",
			subject: "Spanish",
			room: "126A",
			teacher: "Varkey",
		},
	],
};
const PENote =
	"On our PE days, Mondays and Tuesdays, we always have Biology right after lunch, Algebra last, and History NEXT TO PE (either before or after). ";
const TalentNote = "We have Talent on Tuesdays, Thursdays, and Fridays. Tuesdays 5th period right before PE, Thursdays last period, and Fridays second to last period, preceded by History and followed by Spanish. (Band students can easily memorize this because they stay in one side of the building for the last three periods.)";
const days = {
	monday: {
		doubles: [
			{
				subject: "History",
				periods: [2, 6],
			},
		],
		tags: ["PE", "Double"],
		specialNotes: [PENote],
		note: "On Mondays, we have PE 7th, followed by Algebra and preceded by History. We have one double period, History on periods 2 and 6.",
	},
	tuesday: {
		doubles: [
			{
				subject: "Math", // NOT ALGEBRA or NONCORE, MATH MEANS BOTH
				periods: [1, 8],
			},
		],
		tags: ["PE", "Talent", "No Spanish", "Non-Core", "Non-Core Math", "Double"],
		specialNotes: [PENote, TalentNote],
		note: "On Tuesdays, we have PE 6th, followed by History and preceded by Talent. We have a technical double for Math, with Non-Core Math being first and Algebra being last. This is the only day in the school week without Spanish",
	},
	wednesday: {
		doubles: [
			{
				subject: "Algebra",
				periods: [1, 5],
			},
			{
				subject: "English", // Not ELA, both ELA & Noncore Ela
				periods: [2, 4],
			},
		],
		tags: ["Non-Core", "Non-Core ELA", "Double"],
		specialNotes: [],
		note: "This is our only day with Non-Core ELA, situated right after lunch. Our first five periods are as follows: Algebra -> ELA -> Lunch -> Non-Core ELA -> Algebra. This makes it easy to remember, as the two periods after lunch are just the first two periods inversed. We have a genuine Algebra double on this day as well.",
	},
	thursday: {
		doubles: [{ subject: "Biology", periods: [1, 6] }],
		tags: ["Talent", "Double"],
		specialNotes: [TalentNote],
		note: "This our day with a biology double period.",
	},
	friday: {},
};
const _options = {
	left: [
		{
			colored: false,
		},
	],
	middle: [{}],
	right: [
		{
			colors: {
				border: "#cad3f5",
				text: "#cad3f5",
				background: "#181926",
			},
		},
	],
};
const _additionalTeachers = {
	// Talent teachers to be done
};
const _defaultColors = {
	Algebra: "#8aadf4",
	Biology: "#a6da95",
	ELA: "#ed8796",
	History: "#eed49f",
	"Non-Core ELA": "",
	"Non-Core Math": "",
	Spanish: "#c6a0f6",
	Talent: "",
	PE: "#f5a97f",
	Lunch: "#ee99a0",
};

/*
// Testing purposes
const _oldDate = Date;
const fakeDate = new Date("March 26, 2025 11:13:00");

// Overriding date function
Date = function () {
	return fakeDate;
};
*/
function _getPeriod() {
	// Get current day, ensure that it is monday through friday
	// const now = new Date(2024, 12, 20, 9, 30); // Testing purposes
	const now = new Date();
	const day = now.getDay();
	if (day === 0 || day === 6) {
		return null;
	}

	// Get current time, ensure that it is between 8:10 am and 2:30 pm
	const hour = now.getHours();
	const minute = now.getMinutes();
	const currentTimeInMinutes = hour * 60 + minute;

	if (!(currentTimeInMinutes >= 490 && currentTimeInMinutes <= 870)) {
		return null;
	}

	// Get current day in text
	const daysOfWeek = [
		"sunday",
		"monday",
		"tuesday",
		"wednesday",
		"thursday",
		"friday",
		"saturday",
	];
	const todaySchedule = schedule[daysOfWeek[day]];

	// Check which period it currently is
	for (const period of todaySchedule) {
		const [start, end] = period.timeRange.split("-");
		const [startHour, startMinute] = start.split(":").map(Number);
		const [endHour, endMinute] = end.split(":").map(Number);

		const startTimeInMinutes = startHour * 60 + startMinute;
		const endTimeInMinutes = endHour * 60 + endMinute;

		if (
			currentTimeInMinutes >= startTimeInMinutes &&
			currentTimeInMinutes <= endTimeInMinutes
		) {
			return period;
		}
	}

	return null;
}

const daysOfSchoolWeek = [
	"monday",
	"tuesday",
	"wednesday",
	"thursday",
	"friday",
];

/**
 * Updates the gradient for each day of the school week in the default schedule based on the current time
 */
function updateDayGradients() {
	// Get the index of the current day in the school week
	const schoolToday = (new Date().getDay() + 6) % 7;

	// Loop through each day of the school week
	for (const day of daysOfSchoolWeek) {
		// Get the table header element for the current day being looped through
		const th = document.querySelector(`#defaultschedule th[data-day="${day}"]`);

		// Get the index of the current day in the array of strings containing school day names.
		const dayIndex = daysOfSchoolWeek.indexOf(day);

		// If the current day is in the past, set the background to blue
		if (dayIndex < schoolToday) {
			th.style.background = "var(--blue)";
		}
		// If the current day is today, calculate the gradient percentage
		else if (dayIndex === schoolToday) {
			// Get the current time
			const now = new Date();
			const hour = now.getHours();
			const minute = now.getMinutes();

			// Calculate the current time in minutes
			const currentTimeInMinutes = hour * 60 + minute;

			// Define the start and end times for the gradient
			const startTimeInMinutes = 8 * 60 + 10; // 8:10
			const endTimeInMinutes = 14 * 60 + 30; // 14:30

			// If the current time is after the end time, set the background to blue
			// This is being done because it will attempt to run the gradient AFTER SCHOOL
			// ^ which means not redundant
			if (currentTimeInMinutes > endTimeInMinutes) {
				th.style.background = "var(--blue)";
			} else if (currentTimeInMinutes < startTimeInMinutes) {
				// Don't bother if school hasn't started yet
				th.style.background = "";
			}
			// Otherwise, calculate the gradient percentage
			else {
				// Calculate the percentage of the day that has passed
				const percentage =
					((currentTimeInMinutes - startTimeInMinutes) /
						(endTimeInMinutes - startTimeInMinutes)) *
					100;

				// Set the background to a linear gradient with the percentage
				th.style.background = `linear-gradient(to right, var(--blue), transparent ${percentage}%)`;
			}
		}
	}
}

/**
 * Updates the gradient for each period in the default schedule based on the current time
 */
// Current problem: Gradients aren't accurate, percentage may be accurate but not represented as so.
function updatePeriodGradients() {
	// Get the day of the week
	const schoolToday = (new Date().getDay() + 6) % 7;

	// Loop through each day of the school week
	for (const day of daysOfSchoolWeek) {
		// The variable day returns a string of a day in the school week
		// Loop through each period for the current day
		for (const period of schedule[day]) {
			// The variable period returns an object with details about the period.
			// Continue only of today is the current day
			if (day !== daysOfSchoolWeek[schoolToday]) {
				continue;
			}

			// Getting the element corresponding to the current period being looped through.
			const td = document.querySelector(
				`#defaultschedule td[data-period="${day}-${schedule[day].indexOf(period) + 1}"]`
			);

			// Get the time in minutes for the current time
			const now = new Date();
			const hour = now.getHours();
			const minute = now.getMinutes();
			const currentTimeInMinutes = hour * 60 + minute;

			// Get the start and end time in minutes for the current period
			const [start, end] = period.timeRange.split("-");
			const [startHour, startMinute] = start.split(":").map(Number);
			const [endHour, endMinute] = end.split(":").map(Number);
			const startTimeInMinutes = startHour * 60 + startMinute;
			const endTimeInMinutes = endHour * 60 + endMinute;

			// If the current time is after the end of the period, show solid color and stop updating its gradient
			if (currentTimeInMinutes > endTimeInMinutes) {
				// If period has already ended, show solid color and stop updating its gradient
				td.style.background = "var(--blue)";
				td.dataset.periodOver = true;
				continue;
			} else if (
				currentTimeInMinutes >= startTimeInMinutes &&
				currentTimeInMinutes <= endTimeInMinutes
			) {
				// If the current time is between the start and end time of the period, show gradient
				const percentage =
					((currentTimeInMinutes - startTimeInMinutes) /
						(endTimeInMinutes - startTimeInMinutes)) *
					100;
				td.style.background = `linear-gradient(to right, var(--blue), transparent ${percentage}%)`;
			}
		}
	}
}

document.addEventListener("DOMContentLoaded", function () {
	// Get current period
	/* ----------------------------- table creation ----------------------------- */
	function createDefaultTable() {
		const daysOfWeek = ["monday", "tuesday", "wednesday", "thursday", "friday"];
		const table = document.querySelector("#defaultschedule");
		const thead = document.createElement("thead");
		const tbody = document.createElement("tbody");

		// Create table header
		const headerRow = document.createElement("tr");
		for (const day of daysOfWeek) {
			const th = document.createElement("th");
			th.textContent = day.charAt(0).toUpperCase() + day.slice(1);
			th.dataset.day = day;
			headerRow.append(th);
		}

		thead.append(headerRow);
		table.append(thead);

		// Find the maximum number of periods in any day
		const maxPeriods = Math.max(
			...daysOfWeek.map((day) => schedule[day]?.length || 0)
		);

		// Create table body
		for (let periodIndex = 0; periodIndex < maxPeriods; periodIndex++) {
			const row = document.createElement("tr");
			for (const day of daysOfWeek) {
				const td = document.createElement("td");
				const period = schedule[day]?.[periodIndex];
				td.textContent = period ? period.subject : "";
				td.dataset.period = `${day}-${periodIndex + 1}`;
				row.append(td);
			}

			tbody.append(row);
		}

		table.append(tbody);
		return table;
	}

	/* ------------------------------ append tables ----------------------------- */
	// Append default table
	document.body.append(createDefaultTable());
	setInterval(updateDayGradients, 1000);
	setInterval(updatePeriodGradients, 1000);

	// Register click listeners for updating info element
	const defaultTable = document.querySelector("#defaultschedule");
	const infoContainer = document.querySelector("#infocontainer");

	// Register day listeners first (draw from thead > tr)
	for (const td of defaultTable.querySelector("thead > tr").children) {
		td.addEventListener("click", (event) => {
			// map the period object to the event target based on its data period attribute
			// gotta make a day info first
		});
	}

	function _createOptions() {
		const table = document.querySelector("#options");
		const tbody = document.createElement("tbody");

		table.append(tbody);
	}

	// document.body.append(createOptions());
});
